# Fairfield Airport Car Service – Architecture & Current State

_Last updated: <!--DATE_AUTOGENERATED-->_

> **Maintainers:** When you merge a PR that changes any of the areas below, please update this document in the same commit.  (A Husky pre-commit hook can automate the timestamp replacement.)

---

## 1. Foundation / Tech Stack

- **Framework:** Next.js 15.3 (App Router) with React 19
- **Language:** TypeScript (non-strict for now)
- **Styling:** Tailwind CSS v4 (`tailwindcss-animate`, `clsx`, `class-variance-authority`)
- **Backend Services:**
  - Firebase (Auth + Firestore)
  - Google Maps Platform (Server `@googlemaps/google-maps-services-js`, client JS SDK)
  - Square SDK for payments
  - Twilio for SMS

## 2. Data Model

### `Booking`
| field | type | notes |
| ----- | ---- | ----- |
| `id` | string | Firestore doc id |
| `name`, `email`, `phone` | string |  |
| `pickupLocation`, `dropoffLocation` | string | full address |
| `pickupDateTime` | Date | JS `Date` object |
| `flightNumber` | string? | optional |
| `passengers` | number | 1–6 |
| `notes` | string? | rider notes |
| `status` | `'pending' \| 'confirmed' \| 'cancelled' \| 'completed'` | |
| `fare` | number | integer dollars |
| `createdAt`, `updatedAt` | Date | timestamps |

## 3. API Routes (App Router)

| route | purpose |
| ----- | ------- |
| `POST /api/places-autocomplete` | Google **Places Autocomplete** wrapper |
| `POST /api/estimate-fare` | Google **Distance Matrix** → fare calculation |
| `POST /api/create-checkout-session` | Square payment link (stub) |
| `POST /api/send-confirmation` | SMS confirmation via Twilio |
| `POST /api/send-feedback-request` | SMS feedback link via Twilio |

## 4. Server-side Helpers (`src/lib`)
- `booking-service.ts` – Firestore CRUD wrappers
- `feedback-service.ts` – Create feedback doc
- `auth-service.ts` – Firebase Auth helpers
- `square-service.ts` – Build Square order & (TODO) real payment link
- `twilio-service.ts` – Send SMS messages

## 5. Front-end Routes

Public flow:
- `/book` – booking form (address autocomplete, fare estimate)
- `/status/[id]` – booking status
- `/cancel` – cancel booking
- `/feedback/[id]` – feedback form

Admin flow:
- `/admin/bookings` – protected list view (via `withAuth`)

## 6. Environment Variables

| name | exposure | description |
| ---- | -------- | ----------- |
| `NEXT_PUBLIC_GOOGLE_MAPS_API_KEY` | client | referrer-restricted browser key |
| `GOOGLE_MAPS_API_KEY` | server | unrestricted for server calls |
| `SQUARE_ACCESS_TOKEN`, `SQUARE_LOCATION_ID` | server | Square payments |
| `SQUARE_WEBHOOK_SIGNATURE_KEY` | server | Webhook signature verification |
| `EMAIL_HOST`, `EMAIL_PORT`, `EMAIL_USER`, `EMAIL_PASS`, `EMAIL_FROM` | server | SMTP credentials for confirmation emails |
| `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER` | server | Twilio SMS |
| `NEXT_PUBLIC_BASE_URL` | client | used to build fallback URLs |

## 7. Known Gaps & TODOs

Scheduled reminders: `POST /api/send-reminders` (triggered by Vercel Cron hourly) sends 24-hour reminder and 30-minute "on my way" texts.

See `TODO.md` for an up-to-date task list. Highlights:
- Replace mock Square link with real checkout + webhook
- Improve small-screen layout of `/book`
- Enable TypeScript `strict` mode and address errors
- Add tests & CI checks

---

### How to Keep This Document Fresh
1. **Small changes?** Update the relevant bullet(s) manually.
2. **Big PR?** Add a section to your PR template checklist: “☐ Updated `ARCHITECTURE.md`”.
3. **Automate timestamp:** Add a Husky pre-commit hook that replaces `<!--DATE_AUTOGENERATED-->` with `$(date +%Y-%m-%d)`.

_Thanks for keeping our docs living and accurate!_ 