name: ESLint Automation

on:
  pull_request:
    types: [closed]
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run automation'
        required: false
        default: false
        type: boolean

env:
  ESLINT_AUTOMATION_ENABLED: true

permissions:
  contents: write
  pull-requests: write

jobs:
  eslint-automation:
    if: |
      ${{ vars.ESLINT_AUTOMATION_ENABLED != 'false' }} &&
      (${{ github.event.pull_request.merged == true &&
          (contains(github.event.pull_request.title, 'ESLint') ||
           contains(github.event.pull_request.title, 'eslint-fixes')) }} ||
       github.event_name == 'workflow_dispatch' ||
       github.event_name == 'push' ||
       github.event.inputs.force_run == 'true')

    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint automation
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/eslint-automation.js --max-retries=3
        continue-on-error: true

      - name: Check for automation results
        id: check-results
        run: |
          if [ -f "scripts/eslint-automation/automation-results.json" ]; then
            echo "has_results=true" >> $GITHUB_OUTPUT
            cp scripts/eslint-automation/automation-results.json automation-results.json
          else
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        if: steps.check-results.outputs.has_results == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('automation-results.json', 'utf8'));
            if (results.success && results.batchesProcessed > 0) {
              const comment = `ü§ñ ESLint automation completed successfully!\n\n**Batches Processed**: ${results.batchesProcessed}/${results.totalBatches}\n\nNew pull requests have been created for ESLint fixes. Check the [ESLint automation](https://github.com/${{ github.repository }}/actions) for details.`;
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      - name: Handle failures
        if: failure()
        run: |
          echo "‚ùå ESLint automation failed"
          echo "Check the logs above for details"
          echo "You can manually trigger a retry with:"
          echo "gh workflow run eslint-automation.yml --field force_run=true"
